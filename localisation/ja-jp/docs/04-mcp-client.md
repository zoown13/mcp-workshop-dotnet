# 04: MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ

ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã¯ã€To-Doãƒªã‚¹ãƒˆç®¡ç†ç”¨ã®MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚

## å‰ææ¡ä»¶

æº–å‚™ã«ã¤ã„ã¦ã¯[README](../README.md#å‰ææ¡ä»¶)ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ã¯ã˜ã‚ã«

- [GitHubå€‹äººã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆPATï¼‰ã®æº–å‚™](#githubå€‹äººã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³patã®æº–å‚™)
- [MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–‹ç™ºã®æº–å‚™](#mcpã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–‹ç™ºã®æº–å‚™)
- [MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…](#mcpã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…)
- [MCPã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ—ãƒªã®å®Ÿè¡Œ](#mcpã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ—ãƒªã®å®Ÿè¡Œ)
- [MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã®å®Ÿè¡Œ](#mcpã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã®å®Ÿè¡Œ)
- [ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—](#ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—)

## GitHubå€‹äººã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆPATï¼‰ã®æº–å‚™

MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªé–‹ç™ºã®ãŸã‚ã«ã€AIãƒ¢ãƒ‡ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒå¿…è¦ã§ã™ã€‚ã“ã®ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—ã§ã¯ã€[GitHub Models](https://github.com/marketplace?type=models)ã®[OpenAI GPT-4.1-mini](https://github.com/marketplace/models/azure-openai/gpt-4-1-mini)ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

GitHub Modelsã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã«ã¯ã€[GitHubå€‹äººã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ï¼ˆPATï¼‰](https://docs.github.com/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens)ãŒå¿…è¦ã§ã™ã€‚

PATã‚’å–å¾—ã™ã‚‹ã«ã¯ã€[GitHubè¨­å®š](https://github.com/settings/personal-access-tokens/new)ã«ç§»å‹•ã—ã¦æ–°ã—ã„PATã‚’ä½œæˆã—ã¾ã™ã€‚å¿…ãš"Models"ã«å¯¾ã—ã¦æ¨©é™ã‚’"èª­ã¿å–ã‚Šå°‚ç”¨"ã«è¨­å®šã—ã¦ãã ã•ã„ã€‚

## MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆé–‹ç™ºã®æº–å‚™

[å‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³](./01-mcp-server.md)ã§ã€MCPã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã®ä¸¡æ–¹ã‚’ã™ã§ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸã€‚ãã‚Œã‚’ä½¿ã„ç¶šã‘ã¾ã—ã‚‡ã†ã€‚

1. ç’°å¢ƒå¤‰æ•°`$REPOSITORY_ROOT`ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

   ```bash
   # bash/zsh
   REPOSITORY_ROOT=$(git rev-parse --show-toplevel)
   ```

   ```powershell
   # PowerShell
   $REPOSITORY_ROOT = git rev-parse --show-toplevel
   ```

1. `workshop`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ã—ã¾ã™ã€‚

    ```bash
    cd $REPOSITORY_ROOT/workshop
    ```

1. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã«GitHub PATã‚’è¿½åŠ ã—ã¾ã™ã€‚`{{ GITHUB_PAT }}`ã‚’å‰ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ç™ºè¡Œã•ã‚ŒãŸGitHub PATã«ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

    ```bash
    dotnet user-secrets --project ./src/McpTodoClient.BlazorApp set GitHubModels:Token "{{ GITHUB_PAT }}"
    ```

1. ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

    ```bash
    dotnet watch run --project ./src/McpTodoClient.BlazorApp
    ```

1. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¦ã‚¢ãƒ—ãƒªãŒå‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚ä»¥ä¸‹ã¯ä¾‹ã§ã™ï¼š

    ```text
    ãªãœç©ºã¯ãã‚“ãªã«é’ã„ã®ã§ã™ã‹ï¼Ÿ
    ```

1. `CTRL`+`C`ã‚’å…¥åŠ›ã—ã¦ã‚¢ãƒ—ãƒªã‚’åœæ­¢ã—ã¾ã™ã€‚

## MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®å®Ÿè£…

1. MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

    ```bash
    cd $REPOSITORY_ROOT/workshop/src/McpTodoClient.BlazorApp
    ```

1. MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã®NuGetãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã¾ã™ã€‚

    ```bash
    dotnet add package ModelContextProtocol.AspNetCore --prerelease
    ```

1. `Program.cs`ã‚’é–‹ãã€è¿½åŠ ã®`using`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«è¿½åŠ ã—ã¾ã™ï¼š

    ```csharp
    using System.ClientModel;
    using McpTodoClient.BlazorApp.Components;
    using Microsoft.Extensions.AI;
    
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿½åŠ  ğŸ‘‡ğŸ‘‡ğŸ‘‡
    using ModelContextProtocol.Client;
    using ModelContextProtocol.Protocol;
    // ğŸ‘†ğŸ‘†ğŸ‘† è¿½åŠ  ğŸ‘†ğŸ‘†ğŸ‘†
    
    using OpenAI;
    ```

1. åŒã˜`Program.cs`ã§ã€`var app = builder.Build();`è¡Œã‚’è¦‹ã¤ã‘ã¦ã€ãã®ç›´å‰ã«ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰è¡Œã‚’è¿½åŠ ã—ã¾ã™ã€‚

    ```csharp
    builder.Services.AddChatClient(chatClient)
                    .UseFunctionInvocation()
                    .UseLogging();
    
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿½åŠ  ğŸ‘‡ğŸ‘‡ğŸ‘‡
    builder.Services.AddSingleton<IMcpClient>(sp =>
    {
        var loggerFactory = sp.GetRequiredService<ILoggerFactory>();
    
        var uri = new Uri("http://localhost:5242");
    
        var clientTransportOptions = new SseClientTransportOptions()
        {
            Endpoint = new Uri($"{uri.AbsoluteUri.TrimEnd('/')}/mcp")
        };
        var clientTransport = new SseClientTransport(clientTransportOptions, loggerFactory);
    
        var clientOptions = new McpClientOptions()
        {
            ClientInfo = new Implementation()
            {
                Name = "MCP Todo Client",
                Version = "1.0.0",
            }
        };
    
        return McpClientFactory.CreateAsync(clientTransport, clientOptions, loggerFactory).GetAwaiter().GetResult();
    });
    // ğŸ‘†ğŸ‘†ğŸ‘† è¿½åŠ  ğŸ‘†ğŸ‘†ğŸ‘†
    
    var app = builder.Build();
    ```

1. `Components/Pages/Chat/Chat.razor`ã‚’é–‹ãã€è¿½åŠ ã®`@using`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ã‚’è¿½åŠ ã—ã¾ã™ã€‚

    ```razor
    @page "/"
    
    @using System.ComponentModel
    
    @* ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿½åŠ  ğŸ‘‡ğŸ‘‡ğŸ‘‡ *@
    @using ModelContextProtocol.Client
    @* ğŸ‘†ğŸ‘†ğŸ‘† è¿½åŠ  ğŸ‘†ğŸ‘†ğŸ‘† *@
    
    @inject IChatClient ChatClient
    ```

1. åŒã˜`Components/Pages/Chat/Chat.razor`ã§ã€`IMcpClient`ã‚’åˆ¥ã®ä¾å­˜é–¢ä¿‚ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚

    ```razor
    @inject IChatClient ChatClient
    
    @* ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿½åŠ  ğŸ‘‡ğŸ‘‡ğŸ‘‡ *@
    @inject IMcpClient McpClient
    @* ğŸ‘†ğŸ‘†ğŸ‘† è¿½åŠ  ğŸ‘†ğŸ‘†ğŸ‘† *@
    
    @implements IDisposable
    ```

1. åŒã˜`Components/Pages/Chat/Chat.razor`ã§ã€`@code { ... }`ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ã«ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ã€‚

    ```csharp
    private readonly ChatOptions chatOptions = new();
    
    // ğŸ‘‡ğŸ‘‡ğŸ‘‡ è¿½åŠ  ğŸ‘‡ğŸ‘‡ğŸ‘‡
    private IEnumerable<McpClientTool> tools = null!;
    // ğŸ‘†ğŸ‘†ğŸ‘† è¿½åŠ  ğŸ‘†ğŸ‘†ğŸ‘†
    
    private readonly List<ChatMessage> messages = new();
    ```

1. åŒã˜`Components/Pages/Chat/Chat.razor`ã§ã€`OnInitialized()`ã‚’`OnInitializedAsync()`ã«ç½®ãæ›ãˆã¾ã™ã€‚

    ```csharp
    // Before
    protected override void OnInitialized()
    {
        messages.Add(new(ChatRole.System, SystemPrompt));
    }
    
    // After
    protected override async Task OnInitializedAsync()
    {
        messages.Add(new(ChatRole.System, SystemPrompt));
        tools = await McpClient.ListToolsAsync();
        chatOptions.Tools = [.. tools];
    }
    ```

## MCPã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ—ãƒªã®å®Ÿè¡Œ

1. `workshop`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

    ```bash
    cd $REPOSITORY_ROOT/workshop
    ```

1. MCPã‚µãƒ¼ãƒãƒ¼ã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

    ```bash
    dotnet run --project ./src/McpTodoServer.ContainerApp
    ```

## MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã®å®Ÿè¡Œ

1. `workshop`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚

    ```bash
    cd $REPOSITORY_ROOT/workshop
    ```

1. MCPã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚¢ãƒ—ãƒªã‚’å®Ÿè¡Œã—ã¾ã™ã€‚

    ```bash
    dotnet watch run --project ./src/McpTodoClient.BlazorApp
    ```

1. Webãƒ–ãƒ©ã‚¦ã‚¶ãŒé–‹ã„ãŸã‚‰ã€To-Doãƒªã‚¹ãƒˆé …ç›®ã«é–¢ã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’å…¥åŠ›ã—ã¾ã™ã€‚ä»¥ä¸‹ã¯ä¾‹ã§ã™ï¼š

    ```text
    To-Doãƒªã‚¹ãƒˆã‚’æ•™ãˆã¦ã€‚
    åˆå‰9æ™‚ã«ä¼šè­°ã‚’äºˆç´„ã—ã¦ã€‚
    12æ™‚ã«ãƒ©ãƒ³ãƒã‚’äºˆç´„ã—ã¦ã€‚
    åˆå‰9æ™‚ã®ä¼šè­°ã¯çµ‚äº†ã—ã¾ã—ãŸã€‚
    ãƒ©ãƒ³ãƒã®æ™‚é–“ã‚’åˆå¾Œ1æ™‚ã«å¤‰æ›´ã—ã¦ã€‚
    åˆå¾Œ1æ™‚ã«åˆ¥ã®ä¼šè­°ã‚’äºˆç´„ã—ã¦ã€‚
    åˆå¾Œ1æ™‚ã®ä¼šè­°ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã€‚
    ```

ğŸ‘‰ **ãƒãƒ£ãƒ¬ãƒ³ã‚¸**ï¼š[å‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³](./02-mcp-remote-server.md)ã§ä½œæˆã—ãŸã‚³ãƒ³ãƒ†ãƒŠã¾ãŸã¯ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ã§MCPã‚µãƒ¼ãƒãƒ¼ã‚’ç½®ãæ›ãˆã¦ãã ã•ã„ã€‚

## ãƒªã‚½ãƒ¼ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

1. ä½¿ç”¨ã—ãŸã™ã¹ã¦ã®ã‚³ãƒ³ãƒ†ãƒŠã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

    ```bash
    docker rmi mcp-todo-http:latest --force
    ```

1. Azureã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸã™ã¹ã¦ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã€‚

    ```bash
    azd down --force --purge
    ```

---

ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ‰ ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—ã®ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼

---

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯[GitHub Copilot](https://docs.github.com/copilot/about-github-copilot/what-is-github-copilot)ã«ã‚ˆã£ã¦ãƒ­ãƒ¼ã‚«ãƒ©ã‚¤ã‚ºã•ã‚Œã¾ã—ãŸã€‚ãã®ãŸã‚ã€èª¤ã‚ŠãŒå«ã¾ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ä¸é©åˆ‡ã¾ãŸã¯é–“é•ã£ãŸç¿»è¨³ã‚’è¦‹ã¤ã‘ãŸå ´åˆã¯ã€[issue](../../../../../issues)ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
